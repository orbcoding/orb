#!/bin/bash

# Set project root
_orb_root="${BASH_SOURCE[0]}"
_orb_root="${_orb_root%/*/*}"

source "$_orb_root/scripts/version_check.sh"

if [ ! $_orb_initialized ]; then
  source "$_orb_root/scripts/initialize.sh"

  # Prefer declaring orb function here for minimal stack trace
  orb() {
    source "$_orb_root/scripts/call/history.sh"
    source "$_orb_root/scripts/call/variables.sh"
    source "$_orb_root/scripts/call/extensions.sh"
    source "$_orb_root/scripts/call/settings.sh" "$@" && shift $?
    source "$_orb_root/scripts/call/namespace_and_function.sh"

    # Get function declaration
    if [[ -n $_orb_function_name ]]; then
      source "$_orb_root/scripts/call/source_function_file.sh"
      _orb_parse_function_declaration
    fi

    # Handle help
    if _orb_handle_help; then
      source "$_orb_root/scripts/call/cleanup.sh" 
      return 0
    fi

    # Get function args and source presource files
    source "$_orb_root/scripts/call/function_args.sh"
    source "$_orb_root/scripts/call/source_presource.sh"

    # Call function
    $_orb_function_name "${_orb_args_positional[@]}"
    _orb_function_exit_code=$?
    source "$_orb_root/scripts/call/cleanup.sh" 
    return $?
  }

  _orb_initialized=1
fi

# Source or call orb
if _orb_sourced; then
  source "$_orb_root/scripts/handle_orb_sourced.sh" 
else 
  orb "$@"
fi
