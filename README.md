# orb
`orb` is an extendable bash cli companion for developers. It functions as a wrapper for bash commands and provides explicit argument declaration, collection, validation and simple autogenerated docs.

The `orb` core comes with some built in commands and utils, mostly related to docker container management, see core namespaces section.

---

## How it works

All you have to do is put your functions inside an orb extension file and declare your functions arguments eg like below:

```BASH
touch my_project_root/_orb_extensions/my_namespace.sh
chmod +x my_project_root/_orb_extensions/my_namespace.sh


# my_project_root/_orb_extensions/my_namespace.sh

# my_function
declare -A my_function_args=(
  ['1']='first inline argument'
  ['2']='second inline argument'
  ['-b']='boolean flag'
  ['-f arg']='flag followed by argument'
  ['*']='rest of arguments'
); function my_function() { # This is my function comment
  echo "$1 $2"
  ${_args[-b]} && echo "got -b"
  echo "got -f arg: ${_args[-f arg]}"
  echo "rest of args: ${_args_wildcard[@]}"
}


# Then call your extended function from anywhere inside your project
$ orb my_namespace my_function -bf arg_f arg_1 arg_2 some more args
# =>
#  arg_1 arg_2
#  got -b
#  got -f arg: arg_f
#  rest of args: some more args

$ orb my_namespace --help
# =>
#  -----------------     local _orb_extensions
#  MY_NAMESPACE.SH
#    my_function         This is my function comment

$ orb my_namespace my_function --help
# =>
#  my_function - This is my function comment
#
#    ARG     DESCRIPTION                DEFAULT  IN  REQUIRED  OTHER
#    1       first inline argument      -        -   true      -
#    2       second inline argument     -        -   true      -
#    -b      boolean flag               -        -   -         -
#    -f arg  flag followed by argument  -        -   -         -
#    *       rest of arguments          -        -   true      -
```
---

## Installation
```BASH
  cd my_dir
  git clone https://github.com/sharetransition/orb-cli.git
  # Extend path in ~/.bashrc or ~/.zshrc and resource/restart shell
  PATH=$PATH:my_dir/orb-cli

  # Now you can use the orb command
  orb --help
```
---

## More on arguments and functions

Functions callable through orb and listed in help - aka. "`public functions`" - have to be declared with `function` prefix and `()`. If not it will be considered a "`private function`" that is used internally in the file. See `orb utils _has_public_function`

```BASH
 declare -A my_function_args=(
  ['1']='short description of first arg; IN: value1|value2|value3; DEFAULT: $checkedvar1|$checkedvar2|value3'
  ['2']='second arg; OPTIONAL'
  ['-r']='r flag description; DEFAULT: true'
  ['-e arg']='-e flag followed by value arg; REQUIRED'
  ['*']='matches rest of args when args not declared or optional arguments fail IN-validation'
 ); function my_function() {}

 Boolean flags should be single char to allow multiple flag statements such as -ri

 calling `orb my_function +r` sets [-r]=false. Useful if [-r]=DEFAULT: true - Inspired by bash options https://tldp.org/LDP/abs/html/options.html

 Note the available argument properties
 - Numbered args are required unless prop OPTIONAL or supplied DEFAULT
 - Flag args are optional unless prop REQUIRED
 - IN lists multiple accepted values with |
 - DEFAULT can eval variables and falls back through | chain when undef.
 - ['*'] or ['1'] (any nr) with ACCEPTS_FLAGS allows unrecognized flag to start assignment. Otherwise invalid flag error is raised.


 Values are then stored in $_args associative array
 and can be retrieved by eg:

 ${_args["-e arg"]} => arg_value if applied
 ${_args[-e]} => true if applied, otherwise false
 ${_args['*']} => true if wildcard arguments assigned, otherwise false
 ${_args_wildcard[@]} holds wildcard args (separate variable as bash does not support nested arrays)

 Numbered args and wildcards also passed as inline args to function call.
 This allows expected access through: $1, $2, $@/$* etc


 If the first argument of any function is --help
 An argument help output will be printed
```

---
## Core namespaces and commands
See `orb --help` for more information about core namespaces and functions. As with the creation of a new namespace shown in the introduction, you can also hook into and extend/override core namespaces in the same way. Any functions/commands prefixed with `_` are already sourced/required by the core and can be called directly without `orb` prefix (if so however without argument collection/validation)

### `docker` - Default namespace
`docker` is the default namespace when calling `orb function_name` without namespace prefix. Change by `export ORB_DEFAULT_NAMESPACE=my_namespace` or setting up an alias `alias orb="ORB_DEFAULT_NAMESPACE=my_namespace orb"`.

Docker commands expect project root to contain the following files:

- `docker-compose.yml`  - shared base file
- `docker-compose.dev.yml`
- `docker-compose.prod.yml`
- `docker-compose.staging.yml`
- `docker-compose.idle.yml` - useful for debugging when usual startup command fails
- `.env` - with some vars listed below
- `_docker/Dockerfile` -  for rebuilding main image

#### For example:

- `orb start dev` will start your docker-compose project with base file + dev. Also provides $CURRENT_ENV/$CURRENT_ID/$CURRENT_GID that can used in your compose files. Eg:

```YML
# docker-compose.yml
services:
  db:
    image: postgres:11-alpine
    volumes:
      - ../${CURRENT_ENV}.db:/var/lib/postgresql/dat
  web:
    user: ${CURRENT_ID}:${CURRENT_GID}
```

- `orb start dev -i` will start your docker-compose project with base file + dev + idle
- `orb bash prod -r -s db` will enter the db service container in your production compose project as root with bash/sh
- `orb bash dev -s web pwd` will run pwd command inside container

`my_project_root/.env`
```BASH
SRV_USER=admin # Used by orb to connect to server
SRV_DOMAIN=123.123.123.123
SRV_REPO_PATH=/home/srv_user/my_project_root

APP_NAME=smilingbasil # Container name prefix
DEFAULT_SERVICE=web
BUILD_IMAGE=dockerhub_user/image # If image exists locally or on docker hub, it will be used instead of Dockerfile
PARENT_IMAGE=ruby:2.7.2-alpine # To force build from _docker/Dockerfile, use orb docker rebuild
```

## TODO
- Add `generate` namespace that generates containerized applications with orb support. First `rails` w. `alchemy_cms` option. Then probably `nuxtjs`
- Add optional core `deploy` cmds for `rails`.
